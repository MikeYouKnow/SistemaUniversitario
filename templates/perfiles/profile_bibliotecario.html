{% extends "base.html" %}
{% block title %}Panel de Bibliotecario{% endblock %}

{% block content %}
<div class="container mt-4 page-wrapper">

  {# Encabezado #}
  <div class="mb-3">
    <h2 class="mb-1">Panel de Bibliotecario</h2>
    <p class="text-muted-soft mb-0">
      Bienvenido, {{ user.nombre_usuario if user else 'bibliotecario' }}.
      Desde este panel puedes revisar el catálogo de libros,
      gestionar préstamos y ver el historial de movimientos de la biblioteca.
    </p>
  </div>

  <div class="row g-3">

    {# Columna izquierda: perfil #}
    <div class="col-lg-3">
      <div class="card-soft h-100">
        <div class="card-soft-header bg-primary text-white">
          <span class="section-title text-white">Tu perfil</span>
        </div>
        <div class="card-soft-body">
          <p class="mb-1"><strong>Usuario:</strong> {{ user.nombre_usuario }}</p>
          <p class="mb-1"><strong>Correo:</strong> {{ user.correo_electronico }}</p>
          <p class="mb-0"><strong>Rol actual:</strong> Bibliotecario</p>
        </div>
      </div>
    </div>

    {# Columna derecha: resumen biblioteca #}
    <div class="col-lg-9">
      <div class="card-soft h-100">
        <div class="card-soft-header d-flex justify-content-between align-items-center">
          <span class="section-title">Resumen de la biblioteca</span>
          <span class="text-muted-soft small">Vista general</span>
        </div>
        <div class="card-soft-body">
          <div class="row text-center g-3">
            <div class="col-6 col-md-3">
              <div class="fw-bold fs-4">
                {{ resumen.total_libros or 0 }}
              </div>
              <div class="text-muted-soft small">Libros en catálogo</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="fw-bold fs-4">
                {{ resumen.prestamos_activos or 0 }}
              </div>
              <div class="text-muted-soft small">Préstamos activos</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="fw-bold fs-4">
                {{ resumen.alumnos_con_prestamo or 0 }}
              </div>
              <div class="text-muted-soft small">Estudiantes con préstamo</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="fw-bold fs-4">
                {{ resumen.prestamos_retrasados or 0 }}
              </div>
              <div class="text-muted-soft small">Préstamos retrasados</div>
            </div>
          </div>
          <p class="text-muted-soft small mt-3 mb-0">
            Estos datos se actualizan directamente desde las tablas de <code>biblioteca</code>.
          </p>
        </div>
      </div>
    </div>

  </div>

  {# Catálogo y préstamos #}
  <div class="card-soft mt-4">
    <div class="card-soft-header">
      <span class="section-title">Catálogo y préstamos</span>
    </div>
    <div class="card-soft-body">

      <form method="get" action="{{ url_for('perfil_bibliotecario') }}" class="row g-2 mb-3">
        <div class="col-md-8 col-lg-10">
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Buscar libro por título, autor, clasificación o editorial..."
            value="{{ q or '' }}"
          >
        </div>
        <div class="col-md-4 col-lg-2 d-grid">
          <button type="submit" class="btn btn-primary">
            Buscar
          </button>
        </div>
      </form>

      {% if libros %}
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Título</th>
                <th>Clasificación</th>
                <th>Editorial</th>
                <th class="text-center">Disponibles</th>
                <th class="text-center">Acción</th>
              </tr>
            </thead>
            <tbody>
              {% for l in libros %}
              <tr>
                <td>{{ l.titulo_libro }}</td>
                <td>
                  {{ l.codigo_clasificacion }}
                  <span class="text-muted-soft small d-block">
                    {{ l.clasificacion_desc }}
                  </span>
                </td>
                <td>{{ l.nombre_editorial }}</td>
                <td class="text-center">{{ l.disponibles }}</td>
                <td class="text-center">
                  <a href="{{ url_for('biblioteca_libro_detalle', id_libro=l.id_libro) }}"
                     class="btn btn-sm btn-outline-primary">
                    Ver detalle
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info mb-0">
          No se encontraron libros que coincidan con la búsqueda.
        </div>
      {% endif %}

    </div>
  </div>

</div>
{% endblock %}
