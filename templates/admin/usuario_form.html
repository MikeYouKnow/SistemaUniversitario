{% extends "base.html" %}
{% block title %}
  {% if modo == 'nuevo' %}Nuevo usuario{% else %}Editar usuario{% endif %}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">
    {% if modo == 'nuevo' %}Nuevo usuario{% else %}Editar usuario{% endif %}
  </h4>
  <a href="{{ url_for('admin_usuarios_list', modo='edit') }}" class="btn btn-outline-secondary btn-sm">
    ← Volver a la lista
  </a>
</div>

<div class="card">
  <div class="card-body">
    <form method="post">
      {% if modo == 'nuevo' %}
        <div class="mb-3">
          <label class="form-label">Nombre de usuario</label>
          <input type="text" name="nombre_usuario" class="form-control" required>
        </div>
      {% else %}
        <div class="mb-3">
          <label class="form-label">Nombre de usuario</label>
          <input type="text" class="form-control" value="{{ usuario.nombre_usuario }}" disabled>
          <div class="form-text">El nombre de usuario no se edita en esta versión.</div>
        </div>
      {% endif %}

      <div class="mb-3">
        <label class="form-label">Correo electrónico</label>
        <input type="email"
               name="correo_electronico"
               class="form-control"
               required
               value="{{ usuario.correo_electronico if usuario else '' }}">
      </div>

      {% if modo == 'nuevo' %}
        <div class="mb-3">
          <label class="form-label">Contraseña inicial</label>
          <input type="text" name="contrasena" class="form-control" required>
          <div class="form-text">En producción debería generarse o cifrarse automáticamente.</div>
        </div>
      {% else %}
        <div class="mb-3 form-check">
          <input class="form-check-input" type="checkbox" name="activo" id="chkActivo"
                 {% if usuario.activo %}checked{% endif %}>
          <label class="form-check-label" for="chkActivo">
            Usuario activo
          </label>
        </div>
      {% endif %}

      <div class="mb-3">
        <label class="form-label">Rol principal</label>
        {% if modo == 'nuevo' %}
          <select name="id_rol" class="form-select" required>
            <option value="">Selecciona un rol...</option>
            {% for r in roles %}
              <option value="{{ r.id_rol }}">{{ r.nombre_rol }}</option>
            {% endfor %}
          </select>
        {% else %}
          <div class="row">
            {% for r in roles %}
              <div class="col-md-3 col-6">
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         name="roles"
                         value="{{ r.id_rol }}"
                         id="rol{{ r.id_rol }}"
                         {% if r.id_rol in usuario.roles_ids %}checked{% endif %}>
                  <label class="form-check-label" for="rol{{ r.id_rol }}">
                    {{ r.nombre_rol }}
                  </label>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="form-text">Puedes asignar uno o varios roles al usuario.</div>
        {% endif %}
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">
          {% if modo == 'nuevo' %}Crear usuario{% else %}Guardar cambios{% endif %}
        </button>
        <a href="{{ url_for('admin_usuarios_list', modo='edit') }}" class="btn btn-link">
          Cancelar
        </a>
      </div>
    </form>
  </div>
</div>

{% endblock %}
